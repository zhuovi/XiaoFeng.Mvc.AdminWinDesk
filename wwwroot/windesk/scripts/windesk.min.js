layui.define(["jquery","layer","alerter"],function(n){"use strict";var t=layui.$,f=layui.form,r=layui.layer,i=layui.alerter,u=function(n){var f=this,u={elem:".windesk",debug:!0,width:700,height:500,iconalign:1,dragicon:!0,deskicon:[{id:1,name:"",url:"",image:"",icon:"","class":"",style:"",type:0,width:0,height:0,lock:!1,children:[{name:"",url:"",icon:"","class":"",style:""}]}],startmenu:{sidebar:[],submenu:[{name:"",url:"",type:0,children:[{name:"",url:"",icon:"","class":"",style:""}]}]},contextmenu:[{name:"桌面设置",icon:"zw-icon zw-icon-set",event:function(){f.Funs.SystemSet()}},{name:"",icon:"",event:null,condition:null},{name:"关于我们",icon:"zw-icon zw-icon-about",event:function(){f.Funs.AboutUs()}},{name:"退出系统",icon:"zw-icon zw-icon-logout1",event:function(){f.Funs.Logout()}}],event:{desktop:{added:function(){return 0},moved:function(){},removed:function(){}}}};u=t.extend({},u,n);this.Options=u;this.Grids=[];this.GridCount=200;var e=[],s=[],h=[],o=[];this.LoadDesktopIcon=function(){e=t('<div class="desktop"><\/div>');u.elem.append(e);this.GetGrid();this.SetIcon()};this.Init=function(){if(u.elem==null||u.elem==""){r.alert("配置出错.",{icon:1});return}typeof u.elem=="string"&&(u.elem.indexOf(".")>-1?u.elem=t(u.elem):u.elem.startsWith("#")||(u.elem=t("#"+u.elem)));this.LoadDesktopIcon();u.debug&&(this.ShowGrid(),this.ShowMoveGrid());this.LoadTaskBar();this.LoadStartMenu();this.LoadCurrentTime();this.LoadContextMenu();t(window).resize(function(){f.UpdateIcon()})};this.GetGrid=function(){var r=e.find("ul"),o;r.length==0&&(r=t("<ul><\/ul"),e.append(r));var s=r.width(),h=r.height(),f=[],n=0,i=0;for(this.GridCount=Math.max(this.GridCount,u.deskicon.length+10),o=0;o<this.GridCount;o++)f.push({startY:n,endY:n+100,startX:i,endX:i+100}),u.iconalign==0?(i+=100,i+100>s&&(n+=100,i=0)):(n+=100,n+100>h&&(n=0,i+=100));return this.Grids=f,f};this.SetIcon=function(){for(var n,f,o=this.Grids,s=e.find("ul"),i=0;i<Math.min(u.deskicon.length,o.length);i++)n=u.deskicon[i],f="",n.icon=n.icon||"",n.image!=""&&n.image!=null?f='<img src="'+n.image+'"/>':(f='<i class="'+n.icon+'"><\/i>',n.class+=" desktop-icon"),s.append('<li style="left:'+o[i].startX+"px;top:"+o[i].startY+"px;"+(n.style||"")+'"'+((n.class||"")==""?"":' class="'+n.class+'"')+' data-id="'+n.id+'" data-oindex="'+i+'" data-url="'+n.url+'" data-type="'+n.type+'" data-name="'+n.name+'" data-width="'+(n.width||0)+'" data-height="'+(n.height||0)+'" data-icon="'+n.icon+'" data-image="'+(n.image||"")+'" data-lock="'+n.lock+'">'+f+"<br/><span>"+n.name+"<\/span><\/li>");var r=this,h=!1,c=!1;s.on("mousedown","li",function(n){var f;if(n.button!=2&&u.dragicon){n.preventDefault();n.stopPropagation();c=!0;f=t(this);t("#temp").remove();var l=t('<div id="temp" class="icon">'+f.html()+"<\/div>"),a=n.clientX,v=n.clientY,o=n.clientX,s=n.clientY,y=a-f.offset().left,p=v-f.offset().top,i=t(this).parent();t(document).on("mousemove",function(n){var u,f;c&&(h=!0,e.append(l),o=n.clientX<=0?0:n.clientX>=t(window).width()?t(window).width():n.clientX,s=n.clientY<=0?0:n.clientY>=t(window).height()?t(window).height():n.clientY,(a!=o||v!=s)&&l.css({left:o-y,top:s-p}).show(),u=r.SearchGrid(o-i.offset().left,s-i.offset().top),i.find(".grid").css("backgroundColor",""),i.find(".grid:eq("+u+")").css("backgroundColor","#aaa"),f=r.SearchMoveGrid(o-i.offset().left,s-i.offset().top),i.find(".movegrid").css("backgroundColor",""),i.find(".movegrid:eq("+f+")").css("backgroundColor","#333"))}).on("mouseup",function(){var n,a;if(c=!1,l.remove(),h){if(i.find(".grid").css("backgroundColor",""),i.find(".movegrid").css("backgroundColor",""),t(document).off("mousemove").off("mouseup"),n=r.SearchGrid(o-i.offset().left,s-i.offset().top),n>i.find("li").length-1&&f.index()!=i.find("li").length-1)i.find("li:last").after(f);else if(n!=null&&n!=f.index())a=r.SearchMoveGrid(o-i.offset().left,s-i.offset().top),u.iconalign==0?a%4==0||a%4==2?i.find("li:eq("+n+")").before(f):i.find("li:eq("+n+")").after(f):a%4==0||a%4==1?i.find("li:eq("+n+")").before(f):i.find("li:eq("+n+")").after(f);else return;r.UpdateIcon();h=!1;typeof u.event.desktop.moved=="function"&&u.event.desktop.moved(e.find("li"))}})}});s.on("dblclick","li",function(){t("#temp").remove();var i=t(this).attr("data-url"),u=t(this).attr("data-name"),s=t(this).attr("data-id"),f=t(this).attr("data-width")||0,e=t(this).attr("data-height")||0,n=t(this).attr("data-image")||"",o=t(this).attr("data-icon")||"";r.Open(u,i,f,e,n==""?o:n)})};this.GetMoveGrid=function(){for(var r,t,u,i=this.Grids,f=[],n=0;n<i.length;n++)for(r=i[n].startY,t=i[n].startX,u=0;u<4;u++)f.push({startY:r,endY:r+50,startX:t,endX:t+50}),t+=50,t+50>i[n].endX&&(r+=50,t=i[n].startX);return f};this.SearchMoveGrid=function(n,t){for(var r=this.GetMoveGrid(),u=null,i=0;i<r.length;i++)n>=r[i].startX&&n<=r[i].endX&&t>=r[i].startY&&t<=r[i].endY&&(u=i);return u};this.SearchGrid=function(n,t){for(var r=this.Grids,u=null,i=0;i<r.length;i++)n>=r[i].startX&&n<=r[i].endX&&t>=r[i].startY&&t<=r[i].endY&&(u=i);return u};this.UpdateIcon=function(){var n=this.GetGrid();e.find("ul>li").each(function(i){t(this).animate({left:n[i].startX,top:n[i].startY})})};this.ShowGrid=function(){var t=this.Grids,n;for(e.find(".grid").remove(),n=0;n<t.length;n++)e.append('<div class="grid" style="left:'+t[n].startX+"px;top:"+t[n].startY+'px">'+n+"<\/div>")};this.ShowMoveGrid=function(){for(var t=this.GetMoveGrid(),n=0;n<t.length;n++)e.append('<div class="movegrid" style="left:'+t[n].startX+"px;top:"+t[n].startY+'px">'+n+"<\/div>")};this.AddDesktopIcon=function(n,i,o,s){var y=this.Grids,p=e.find("ul"),c=p.find("li").length,v;if(c>=this.GridCount){r.alert("当前桌面图标已超过最大限制,请刷新后再试.",{icon:2});return}var h={image:o,icon:s,name:n,url:i,id:0,type:1,style:""},l="",a="";h.image=h.image||"";h.image!=""?l='<img src="'+h.image+'"/>':(l='<i class="'+h.icon+'"><\/i>',a="desktop-icon");v=t('<li style="left:'+y[c].startX+"px;top:"+y[c].startY+"px;"+h.style+'"'+(a==""?"":' class="'+a+'"')+' data-id="'+h.id+'" data-oindex="'+c+'" data-url="'+h.url+'" data-type="'+h.type+'" data-name="'+h.name+'" data-icon="'+h.image+'">'+l+"<br/><span>"+h.name+"<\/span><\/li>");p.append(v);typeof u.event.desktop.added=="function"&&u.event.desktop.added(v,h,f)};this.RemoveDesktopIcon=function(n){var t=e.find("li[data-id='"+n+"']");t.length!=0&&(t.remove(),f.UpdateIcon(),typeof u.event.desktop.removed=="function"&&u.event.desktop.removed(n))};this.SetContextMenu=function(n,i){if(typeof n=="string"){var r=this;t(document).on("contextmenu",n,function(n){r.RenderContextMenu(n.clientX,n.clientY,i,this);n.cancelable&&(n.defaultPrevented||n.preventDefault());n.stopPropagation()})}};this.RenderContextMenu=function(n,i,r,u){var f,e,o;this.RemoveContextMenu();f=t("<div class='context-menu'><ul><\/ul><\/div>");t(document.body).append(f);e=f.find("ul");o=this;r.forEach(function(n){var r=!0,f,i;(typeof n.condition=="function"&&(r=n.condition()),r)&&(n.name==""?(f=t("<hr/>"),e.append(f)):(i=t("<li data-name='"+n.name+"'><a href='javascript:void(0);'><i class='"+n.icon+"'><\/i>"+n.name+"<\/a><\/li>"),i.click(function(){typeof n.event=="function"&&n.event(t(this),u,o);o.RemoveContextMenu()}),e.append(i)))});n+150>document.body.clientWidth&&(n-=150);i+f.height()>document.body.clientHeight&&(i-=f.height());f.css({top:i,left:n})};this.RemoveContextMenu=function(){t(".context-menu").remove()};this.LoadContextMenu=function(){var n=this;this.SetContextMenu(".desktop",[{name:"进入全屏",icon:"zw-icon zw-icon-fullscreen",event:this.Funs.EnableFullScreen,condition:function(){return!document.fullscreen}},{name:"退出全屏",icon:"zw-icon zw-icon-exitfullscreen",event:this.Funs.DisableFullScreen,condition:function(){return document.fullscreen}},{name:"",icon:"",event:null,condition:null},{name:"刷新",icon:"zw-icon zw-icon-refresh",event:this.Funs.Refresh}].concat(u.contextmenu));this.SetContextMenu(".desktop li",[{name:"打开",icon:"zw-icon zw-icon-open",event:function(i,r){var f=t(r).attr("data-url"),e=t(r).attr("data-name"),c=t(r).attr("data-id"),o=t(r).attr("data-width")||0,s=t(r).attr("data-height")||0,h=t(r).attr("data-icon")||"",u=t(r).attr("data-image")||"";n.Open(e,f,o,s,u==""?h:u)}},{name:"删除快捷方式",icon:"zw-icon zw-icon-delete",event:function(i,u){var f=t(u).attr("data-id"),e=t(u).attr("data-lock");if(e==1){r.alert("系统锁定快捷方式不能执行删除操作.",{icon:2});return}n.RemoveDesktopIcon(f)}}]);this.SetContextMenu(".startmenu .submenu a",[{name:"打开",icon:"zw-icon zw-icon-open",event:function(i,r){var u=t(r).attr("data-url"),f=t(r).attr("data-name"),h=t(r).attr("data-id"),e=t(r).attr("data-width")||0,o=t(r).attr("data-height")||0,s=t(r).attr("data-icon")||"";n.Open(f,u,e,o,s)}},{name:"添加快捷方式",icon:"zw-icon zw-icon-delete",event:function(i,r){var u=t(r).attr("data-url"),f=t(r).attr("data-name"),o=t(r).attr("data-id"),e=t(r).attr("data-icon")||"";n.AddDesktopIcon(f,u,"",e)}}]);t(document).click(function(i){i.button||n.RemoveContextMenu();t(i.target).parents(".main-menu").length==0&&t(i.target).parents(".startmenu").length==0&&n.HideStartMenu()});t(document).on("contextmenu",function(n){n.preventDefault();n.stopPropagation()})};this.LoadStartMenu=function(){o=t('<div class="startmenu"><\/div>');u.elem.append(o);this.LoadSideBar();this.LoadSubMenu()};this.ShowStartMenu=function(){s.find(".main-menu").addClass("active");o.animate({width:400,height:500},50)};this.HideStartMenu=function(){s.find(".main-menu").removeClass("active");o.animate({width:0,height:0},50)};this.LoadSideBar=function(){var n=t('<div class="sidebar"><\/div>');o.append(n);u.startmenu.sidebar.forEach(function(i){if(i.name=="empty")n.append('<div class="emptybutton"><\/div>');else{var r=t('<button class="'+i.icon+'" title="'+i.name+'" data-url="'+i.url+'" data-name="'+i.name+'"><\/button>');if(typeof i.event=="function")r.on("click",i.event);n.append(r)}});t(document).on("click",".sidebar button",function(){var n=t(this).attr("data-url")||"",i=t(this).attr("data-name");n!=""&&(f.Open(i,n,600,400,t(this).attr("class")),f.HideStartMenu())})};this.LoadSubMenu=function(){var r=t('<div class="submenu"><\/div>'),n=t("<dl><\/dl>"),i;r.append(n);o.append(r);u.startmenu.submenu.forEach(function(i,r){var f=t('<dt class="'+i.icon+'" data-index="'+r+'" data-url="'+i.url+'">'+i.name+"<\/dt>"),u=t('<dd data-index="'+r+'"><\/dd>');n.append(f);n.append(u);i.hasOwnProperty("children")&&i.children.length>0&&i.children.forEach(function(n){u.append(t('<a href="javascript:void(0);" data-url="'+n.url+'" data-name="'+n.name+'" data-icon="'+n.icon+'"><i class="'+n.icon+'"><\/i>'+n.name+"<\/a>"))})});i=this;n.on("click","dt",function(){var r=t(this).attr("data-index"),n=t(this).parent().find("dd[data-index='"+r+"']");if(t(this).hasClass("open")){t(this).removeClass("open");n.animate({height:"0","padding-top":"0","padding-bottom":"0"},100,function(){});return}i.CloseSubMenu();n.animate({height:"100%","padding-top":"5px","padding-bottom":"5px"},100,function(){});t(this).addClass("open")});t(document).on("click",".submenu a",function(){var n=t(this).attr("data-url")||"",r=t(this).attr("data-name");n!=""&&(i.Open(r,n,1200,800,t(this).find("i").attr("class")),i.HideStartMenu())})};this.CloseSubMenu=function(){var n=o.find(".submenu dl dd");n.animate({height:"0","padding-top":"0","padding-bottom":"0"},100,function(){});o.find(".submenu dl dt").removeClass("open")};this.OpenSubMenu=function(){var n=o.find(".submenu dl dd");o.animate({height:"100%","padding-top":"5px","padding-bottom":"5px"},100);o.find(".submenu dl dt").addClass("open")};this.LoadTaskBar=function(){s=t('<div class="taskbar">        <button class="main-menu">            <div class="zw-icon zw-icon-logo zw-logo-icon"><\/div>            <div class="zw-logo-bg"><\/div>        <\/button>        <button class="search">        <span class="zw-icon zw-icon-search"><\/span>        搜索        <\/button>        <div class="taskbar-btns">            <ul>            <\/ul>        <\/div>        <button class="time">07:50:10<br/>1985-10-06<\/button>        <button class="msg zw-icon zw-icon-sms"><\/button>        <button class="showdesk"><\/button>    <\/div>');u.elem.append(s);var n=this;s.on("click",".main-menu",function(){t(this).hasClass("active")?(n.HideStartMenu(),t(this).removeClass("active")):(n.ShowStartMenu(),t(this).addClass("active"))}).on("click",".showdesk",function(){var f=t(this).attr("data-min")||"",n,r,u;f==""?(n=[],t("dl.alerter:visible").each(function(){var r=t(this).attr("data-index");n.push(r);i.min(r)}),t(this).attr("data-min",n.join(",")),r=t(this).parent().find(".taskbar-btns>ul>li.active"),r.length>0&&t(this).attr("data-active",r.attr("data-index"))):(f.split(",").forEach(function(n){i.show(n)}),u=t(this).attr("data-active")||0,u>0&&t(this).parent().find(".taskbar-btns>ul>li[data-index="+u+"]").addClass("active"),t(this).removeAttr("data-min").removeAttr("data-active"))});h=s.find(".taskbar-btns>ul");s.on("click",".taskbar-btns>ul>li",function(r){var u,f;if(r.target.nodeName=="U"){u=t(this).attr("data-index");n.RemoveTaskBar(u);i.close(u);return}u=t(this).attr("data-index");f=h.find("li[data-index='"+u+"']");f.hasClass("active")?(f.removeClass("active"),i.hide(u)):(n.CancelActiveAllTaskBar(),f.addClass("active"),i.topWindows(u),i.show(u));s.find(".showdesk").removeAttr("data-min").removeAttr("data-active")})};this.AddTaskBar=function(n,t,i){var r,u;if(h.find("li[data-index='"+t+"']").length>0){this.ActiveTaskBar(t);return}r="";i=i||"";r=i.indexOf(".")>-1||i.indexOf("/")>-1?'<img src="'+i+'"/>':'<i class="'+i+'"><\/i>';s.find("ul").append('<li data-index="'+t+'">                    '+r+"                    <span>"+n+'<\/span>                <u class="zw-icon zw-icon-delete2"><\/u>                <div class="line"><\/div>            <\/li>');u=h.find("li");u.removeClass("active");u.last().addClass("active")};this.RemoveTaskBar=function(n){h.find("li[data-index='"+n+"']").remove()};this.ActiveTaskBar=function(n){h.find("li").removeClass("active");var t=h.find("li[data-index='"+n+"']");t.addClass("active");i.show(n)};this.CancelActiveAllTaskBar=function(){h.find("li").removeClass("active")};this.CancelActiveTaskBar=function(n){var t,n;h.find("li[data-index='"+n+"']").removeClass("active");t=i.getTopWindow(!0);t!=null&&(n=t.attr("data-index"),h.find("li[data-index='"+n+"']").addClass("active"))};this.LoadCurrentTime=function(){window.setInterval(function(){var i=s.find("button.time").last(),n=new Date,t=function(n){return(n<10?"0":"")+n},r=[t(n.getHours()),":",t(n.getMinutes()),":",t(n.getSeconds()),"<br/>",n.getFullYear(),"-",t(n.getMonth()+1),"-",t(n.getDate())];i.html(r.join(""))},1e3)};this.Open=function(n,r,u,e,o,s){r!=""&&i.open({type:s||0,skin:"windows",icon:o,title:n,fixed:!0,maxmin:!0,area:[u,e],scrollbar:!0,minStack:!0,shade:0,content:r,min:function(n){window.setTimeout(function(){f.CancelActiveTaskBar(n.attr("data-index"))},100)},restore:function(n){f.ActiveTaskBar(n.attr("data-index"))},max:function(n,i){t("#alerter"+i).css("height",t(window).height()-51+"px");f.ActiveTaskBar(n.attr("data-index"))},success:function(t){f.AddTaskBar(n,t.attr("data-index"),o)},cancel:function(n){f.RemoveTaskBar(n.attr("data-index"))},close:function(n){f.RemoveTaskBar(n.attr("data-index"))},active:function(n){f.ActiveTaskBar(n.attr("data-index"))}})};this.Funs={AboutUs:function(){r.open({type:1,closeBtn:1,title:"关于我们",content:'<div class="about">                        <ul>                            <li>当前版本: DeskTop v1.0<\/li>                            <li>作者: Jacky<\/li>                            <li>Email: Jacky@fayelf.com<\/li>                            <li>QQ: 7092734<\/li>                            <li>网址: http://www.fayelf.com<\/li>                            <li>Copyright © (2018 - 2024) FAYELF All Rights Reserved.<\/li>                        <\/ul><\/div>'})},EnableFullScreen:function(){var n=document.documentElement;n.requestFullscreen?n.requestFullscreen():n.mozRequestFullScreen?n.mozRequestFullScreen():n.webkitRequestFullScreen?n.webkitRequestFullScreen():n.msRequestFullscreen&&document.body.msRequestFullscreen()},DisableFullScreen:function(){var n=document;n.fullscreen&&(n.exitFullscreen?n.exitFullscreen():n.mozCancelFullScreen?n.mozCancelFullScreen():n.webkitCancelFullScreen?n.webkitCancelFullScreen():n.msExitFullscreen&&n.msExitFullscreen())},Logout:function(){},SystemSet:function(){},Refresh:function(){window.location.reload()}};this.Init(u)};n("windesk",{render:function(n){return new u(n)}})});